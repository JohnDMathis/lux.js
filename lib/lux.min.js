/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.0.1
 * Url: 
 * License(s): MIT
 */
(function(t,e){if("function"==typeof define&&define.amd)define(["traceur","react","postal.request-response","machina","when","when.pipeline","when.parallel"],e);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,n){return e(require("traceur"),require("react"),t,n,require("when"),require("when/pipeline"),require("when/parallel"))}}})(this,function(t,e,n,i,r,s,a){function o(t){var e,n,i;return $traceurRuntime.createGeneratorInstance(function(r){for(;;)switch(r.state){case 0:e=Object.keys(t)[Symbol.iterator](),r.state=4;break;case 4:r.state=(n=e.next()).done?-2:5;break;case 5:i=n.value,r.state=6;break;case 6:return r.state=2,[i,t[i]];case 2:r.maybeThrow(),r.state=4;break;default:return r.end()}},x,this)}function c(t,e){return e.withContext(t).withConstraint(function(t,e){return!e.hasOwnProperty("originId")||e.originId===n.instanceId()})}function u(t){for(var e,n=[],i=o(t)[Symbol.iterator]();!(e=i.next()).done;){var r=e.value,s=r[0],a=r[1];n.push({actionType:s,waitFor:a.waitFor||[]})}return n}function h(t){return A[t]}function f(t){var e={};return t.forEach(function(t){e[t]=function(){var e=Array.from(arguments);_.publish({topic:"action",data:{actionType:t,actionArgs:e}})}}),e}function l(t,e,n,i){e[n]=function(e){var n=i.apply(t,e.actionArgs.concat([e.deps]));return n instanceof Promise||n&&"function"==typeof n.then?n:new Promise(function(t){t(n)})}}function p(t,e){var n={};"getState"in e||(e.getState=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this).getState.apply(t,$traceurRuntime.spread(e))});for(var i,r=o(e)[Symbol.iterator]();!(i=r.next()).done;){var s=i.value,a=s[0],c=s[1];l(t,n,a,"object"==typeof c?c.handler:c)}return n}function d(t){var e,n,i=t,r=i.namespace,s=void 0===(e=i.handlers)?{}:e,a=void 0===(n=i.storageStrategy)?new C:n;if(r in E)throw new Error(' The store namespace "'+r+'" already exists.');var o=new F(r,s,a);return A[r]=f(Object.keys(s)),o}function m(t){E[t].dispose(),delete E[t]}function g(t,e){var n=e.reduce(function(e,n){return e[n]=t[n]&&t[n].result,e},{});return n}function b(t,e){var n=this;return function(){return a(t.map(function(t){return function(){var i=Object.assign({deps:g(n.stores,t.waitFor)},e);return _.request({topic:"dispatch."+t.namespace,data:i}).then(function(e){n.stores[t.namespace]=n.stores[t.namespace]||{},n.stores[t.namespace].result=e.result})}})).then(function(){return n.stores})}}function v(t,e,n){n=n||0;var i=n;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var r=e[t],s=v(r,e,n+1);s>i&&(i=s)}),i}function y(t){var e=[],n={};t.forEach(function(t){return n[t.namespace]=t}),t.forEach(function(t){return t.gen=v(t,n)});for(var i,r=o(n)[Symbol.iterator]();!(i=r.next()).done;){var s=i.value,a=(s[0],s[1]);e[a.gen]=e[a.gen]||[],e[a.gen].push(a)}return e}function w(t){var n={mixins:[k,q].concat(t.mixins||[])};return delete t.mixins,e.createClass(Object.assign(n,t))}function S(t){var n={mixins:[q].concat(t.mixins||[])};return delete t.mixins,e.createClass(Object.assign(n,t))}var x=$traceurRuntime.initGeneratorFunction(o),_=n.channel("lux"),E={},A={},C=function(t){"use strict";this.state=t||{},this.changedKeys=[]};$traceurRuntime.createClass(C,{getState:function(){"use strict";return new Promise(function(t){t(this.state)}.bind(this))},setState:function(t){"use strict";var e=this;Object.keys(t).forEach(function(t){e.changedKeys[t]=!0}),this.state=Object.assign(this.state,t)},replaceState:function(t){"use strict";var e=this;Object.keys(t).forEach(function(t){e.changedKeys[t]=!0}),this.state=t},flush:function(){"use strict";var t=Object.keys(this.changedKeys);return this.changedKeys={},{changedKeys:t,state:this.state}}},{});var F=function(t,e,n){"use strict";this.namespace=t,this.storage=n,this.actionHandlers=p(this,e),this.__subscription={dispatch:c(this,_.subscribe("dispatch."+t,this.handlePayload)),notify:c(this,_.subscribe("notify",this.flush))},_.publish("register",{namespace:t,actions:u(e)})};$traceurRuntime.createClass(F,{dispose:function(){"use strict";for(var t,e=o(this.__subscription)[Symbol.iterator]();!(t=e.next()).done;){var n=t.value,i=(n[0],n[1]);i.unsubscribe()}},getState:function(){"use strict";for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.storage).getState.apply(t,$traceurRuntime.spread(e))},setState:function(){"use strict";for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.storage).setState.apply(t,$traceurRuntime.spread(e))},replaceState:function(){"use strict";for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.storage).replaceState.apply(t,$traceurRuntime.spread(e))},flush:function(){"use strict";_.publish("notification."+this.namespace,this.storage.flush())},handlePayload:function(t,e){"use strict";var n=this.namespace;this.actionHandlers.hasOwnProperty(t.actionType)&&this.actionHandlers[t.actionType].call(this,t).then(function(t){return e.reply(null,{result:t,namespace:n})},function(t){return e.reply(t)})}},{});var R=function(t){"use strict";Object.assign(this,{generationIndex:0,stores:{}},t),$traceurRuntime.superCall(this,T.prototype,"constructor",[{initialState:"uninitialized",states:{uninitialized:{start:"dispatching"},dispatching:{_onEnter:function(){var e=this;s(function(){for(var n,i=0,r=[],s=t.generations[Symbol.iterator]();!(n=s.next()).done;){var a=n.value;r[i++]=b.call(e,a,t.action)}return r}()).then(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.results=t,console.log("ZE RESULTS"),console.log(t),this.transition("success")}.bind(this),function(t){this.err=t,this.transition("failure")}.bind(this))},_onExit:function(){_.publish("dispatchCycle")}},success:{_onEnter:function(){_.publish("notify",{action:this.action}),this.emit("success")}},failure:{_onEnter:function(){_.publish("failure.action",{action:this.action,err:this.err}),this.emit("failure")}}}}])},T=R;$traceurRuntime.createClass(R,{success:function(t){"use strict";var e=this;return this.on("success",t),this._started||(setTimeout(function(){return e.handle("start")},0),this._started=!0),this},failure:function(t){"use strict";var e=this;return this.on("error",t),this._started||(setTimeout(function(){return e.handle("start")},0),this._started=!0),this}},{},i.Fsm);var j=function(){"use strict";$traceurRuntime.superCall(this,O.prototype,"constructor",[{initialState:"ready",actionMap:{},coordinators:[],states:{ready:{_onEnter:function(){this.luxAction={}},"action.dispatch":function(t){this.luxAction={action:t},this.transition("preparing")},"register.store":function(t){for(var e,n=t.actions[Symbol.iterator]();!(e=n.next()).done;){var i,r=e.value,s=r.actionType,a={namespace:t.namespace,waitFor:r.waitFor};i=this.actionMap[s]=this.actionMap[s]||[],i.push(a)}}},preparing:{_onEnter:function(){var t=this.actionMap[this.luxAction.action.actionType];this.luxAction.generations=y(t),this.transition(this.luxAction.generations.length?"dispatching":"ready")},"*":function(){this.deferUntilTransition("ready")}},dispatching:{_onEnter:function(){var t=this,e=this.luxAction.coordinator=new R({generations:this.luxAction.generations,action:this.luxAction.action});e.success(function(){return t.transition("ready")}).failure(function(){return t.transition("ready")})},"*":function(){this.deferUntilTransition("ready")}},stopped:{}}}]),this.__subscriptions=[c(this,_.subscribe("action",function(t){this.handleActionDispatch(t)})),c(this,_.subscribe("register",function(t){this.handleStoreRegistration(t)}))]},O=j;$traceurRuntime.createClass(j,{handleActionDispatch:function(t){"use strict";this.handle("action.dispatch",t)},handleStoreRegistration:function(t){"use strict";this.handle("register.store",t)},dispose:function(){"use strict";this.transition("stopped"),this.__subscriptions.forEach(function(t){return t.unsubscribe()})}},{},i.Fsm);var $=new j,k={componentWillMount:function(){this.stores=this.stores||[],this.stateChangeHandlers=this.stateChangeHandlers||{};var t=function(t){this.setState(t.state||t)};this.__subscriptions=this.__subscriptions||[],this.stores.forEach(function(e){var n=e.store||e,i=e.handler||t;this.__subscriptions.push(_.subscribe("notification."+n,function(t){i.call(this,t)}).withContext(this))}.bind(this))},componentWillUnmount:function(){this.__subscriptions.forEach(function(t){t.unsubscribe()})}},q={componentWillMount:function(){this.actions=this.actions||{},this.getActionsFor=this.getActionsFor||[],this.getActionsFor.forEach(function(t){this.actions[t]=h(t)}.bind(this))}};return{channel:_,stores:E,createStore:d,createControllerView:w,createComponent:S,removeStore:m,dispatcher:$,ActionCoordinator:R,getActionCreatorFor:h}});